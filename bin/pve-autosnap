#!/bin/bash
#
# pve-autosnap - Copyright (c) 2018 - Olivier Poncet
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>
#

# ----------------------------------------------------------------------------
# qm interface definitions
# ----------------------------------------------------------------------------

qm="/usr/sbin/qm"
qm_list_vm="list"
qm_list_snapshot="listsnapshot"
qm_create_snapshot="snapshot"
qm_delete_snapshot="delsnapshot"

# ----------------------------------------------------------------------------
# parse the command-line
# ----------------------------------------------------------------------------

if [ "x${0}y" != "xy" ]
then
    self="${0}"
else
    self="pve-autosnap"
fi

if [ "x${1}y" != "xy" ]
then
    opt_vmid="${1}"
else
    opt_vmid="help"
fi

if [ "x${2}y" != "xy" ]
then
    opt_keep="${2}"
else
    opt_keep="1"
fi

# ----------------------------------------------------------------------------
# display help
# ----------------------------------------------------------------------------

if [ "x${opt_vmid}y" = "xhelpy" ]
then
    cat << ____EOF
Usage: ${self} [ help | <vmid> [<keep>] ]

Options:

    help	display this help and exit
    vmid	specifies the virtual machine id, can be 'all' to select all VM
    keep	specifies the maximum number of snapshot to keep (default is 1)

____EOF
    exit 0
fi

# ----------------------------------------------------------------------------
# if the given vmid is 'all', process all of them then exit
# ----------------------------------------------------------------------------

if [ "x${opt_vmid}y" = "xally" ]
then
    vmids="$(${qm} "${qm_list_vm}" | awk '{ print $1 }' | grep -v VMID | sort -n)"
    for vmid in ${vmids}
    do
        if [ "${vmid}" -ge "100" ]
        then
            ${self} "${vmid}" ${opt_keep}
        fi
    done
    exit 0
fi

# ----------------------------------------------------------------------------
# if the given vmid seems to be a vmid, check if this is a valid vmid
# ----------------------------------------------------------------------------

if [ "x$(${qm} status ${opt_vmid} 2>/dev/null)y" = "xy" ]
then
    echo "error: <vmid> does not look like a valid VM ID"
    exit 1
fi

# ----------------------------------------------------------------------------
# prepare the vmid snapshoting
# ----------------------------------------------------------------------------

autosnap_vmid="${opt_vmid}"
autosnap_keep="${opt_keep}"
autosnap_name="autosnap_$(date '+%Y%m%d_%H%M%S')"
autosnap_desc="automatic snapshot"
autosnap_list="$(${qm} "${qm_list_snapshot}" "${autosnap_vmid}" | grep "^autosnap_" | awk '{ print $1 }' | sort)"

# ----------------------------------------------------------------------------
# delete old snapshots for this vmid
# ----------------------------------------------------------------------------

autosnap_left="$(echo "${autosnap_list}" | wc -w)"
for autosnap_item in ${autosnap_list}
do
    if [ "${autosnap_left}" -ge "${autosnap_keep}" ]
    then
        ${qm} "${qm_delete_snapshot}" "${autosnap_vmid}" "${autosnap_item}"
    fi
    autosnap_left=$((autosnap_left - 1))
done

# ----------------------------------------------------------------------------
# create new snapshot for this vmid
# ----------------------------------------------------------------------------

${qm} "${qm_create_snapshot}" "${autosnap_vmid}" "${autosnap_name}" -description "${autosnap_desc}"

# ----------------------------------------------------------------------------
# End-Of-File
# ----------------------------------------------------------------------------
